{% extends "base.html" %}

{% block title %}Polizas CRM Broker{% endblock %}

{% block base_extra_css %}
    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    .card h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        color: #05386B;
    }

    .card-import {
        max-width: 600px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 10px 20px;
    }
    .form-group {
        margin-bottom: 8px;
    }
    label {
        display: block;
        font-size: 12px;
        margin-bottom: 3px;
        color: #495057;
    }
    input, select {
        width: 100%;
        padding: 7px 8px;
        border-radius: 6px;
        border: 1px solid #ced4da;
        font-size: 13px;
    }
    input:focus, select:focus {
        outline: none;
        border-color: #05386B;
        box-shadow: 0 0 0 2px rgba(5,56,107,0.15);
    }

    .btn {
        display: inline-block;
        padding: 7px 14px;
        border-radius: 4px;
        border: none;
        font-size: 13px;
        cursor: pointer;
    }
    .btn-primary { background: #05386B; color: #fff; }
    .btn-secondary { background: #6c757d; color: #fff; }

    .table-card {
        margin-top: 10px;
        overflow-x: auto;   /* mantiene la tabla dentro del rectangulo blanco */
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    thead {
        background: #05386B;
        color: white;
    }
    th, td {
        padding: 8px;
        border-bottom: 1px solid #eee;
        text-align: left;
    }
    tr:nth-child(even) {
        background: #f9f9f9;
    }

    /* columnas mas compactas y alineadas al final */
    table th:nth-last-child(-n+4),
    table td:nth-last-child(-n+4) {
        width: 90px;
        max-width: 90px;
        text-align: center;
        white-space: nowrap;
    }

    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    .badge-vigente {
        background: #d4edda;
        color: #155724;
    }
    .badge-porvencer {
        background: #fff3cd;
        color: #856404;
    }
    .badge-vencida {
        background: #f8d7da;
        color: #721c24;
    }

    .situacion-select {
        width: 140px;
        font-size: 11px;
        padding: 4px 6px;
    }

    .wa-link, .pdf-link {
        font-size: 11px;
        text-decoration: none;
        margin-right: 6px;
    }
    .wa-link { color: #128C7E; }
    .pdf-link { color: #d9534f; }

    .import-info {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 8px;
    }
{% endblock %}

{% block content %}

    <h1>Gestion de Polizas</h1>
    <p class="subtitle">Alta manual, importacion desde Excel y listado completo de polizas.</p>

    <!-- Importar Excel -->
    <div class="card card-import">
        <h3>Importar polizas desde Excel</h3>
        <p class="import-info">
            Usa el modelo de Excel que armamos (mismas columnas que el sistema) y carga varias polizas en un solo paso.
        </p>
        <form action="{{ url_for('importar_polizas') }}" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label>Archivo Excel (.xls / .xlsx)</label>
                <input type="file" name="archivo_excel" accept=".xls,.xlsx" required>
            </div>
            <br>
            <button class="btn btn-secondary">Importar polizas</button>
        </form>
    </div>

    <!-- Alta manual -->
    <div class="card form-card">
        <h3>Nueva poliza</h3>
        <form action="{{ url_for('agregar_poliza') }}" method="post" enctype="multipart/form-data">
            <div class="form-grid">
                <!-- Datos cliente -->
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" name="nombre" required>
                </div>
                <div class="form-group">
                    <label>Apellido</label>
                    <input type="text" name="apellido" required>
                </div>
                <div class="form-group">
                    <label>DNI</label>
                    <input type="text" name="dni">
                </div>
                <div class="form-group">
                    <label>Domicilio</label>
                    <input type="text" name="domicilio">
                </div>
                <div class="form-group">
                    <label>Localidad</label>
                    <input type="text" name="localidad">
                </div>
                <div class="form-group">
                    <label>Provincia</label>
                    <input type="text" name="provincia">
                </div>
                <div class="form-group">
                    <label>Productor interno</label>
                    <input type="text" name="productor_interno">
                </div>
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="text" name="telefono">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Fecha de nacimiento</label>
                    <input type="date" name="fecha_nacimiento">
                </div>

                <!-- Datos poliza -->
                <div class="form-group">
                    <label>Compania</label>
                    <input type="text" name="compania" required>
                </div>

                <div class="form-group">
                    <label>Tipo de seguro</label>
                    <select name="tipo_seguro" id="tipo_seguro">
                        <option value="">Seleccionar...</option>

                        <!-- Vehiculos -->
                        <option value="AUTO">Auto</option>
                        <option value="MOTO">Moto</option>
                        <option value="PICKUP">Pickup / 4x4</option>

                        <!-- Personas -->
                        <option value="VIDA">Vida</option>
                        <option value="VIDA COLECTIVO">Vida colectivo</option>
                        <option value="ACCIDENTES PERSONALES">Accidentes personales</option>

                        <!-- Patrimoniales -->
                        <option value="HOGAR">Hogar / Combinado familiar</option>
                        <option value="INTEGRAL COMERCIO">Integral de comercio</option>
                        <option value="CONSORCIO">Consorcio</option>
                        <option value="RC">Responsabilidad civil</option>
                        <option value="CAUCION">Caucion</option>
                        <option value="ART">ART</option>

                        <!-- Otros -->
                        <option value="TRANSPORTE">Transporte</option>
                        <option value="AGRO">Agro</option>
                        <option value="EMBARCACIONES">Embarcaciones</option>
                        <option value="ELECTRONICOS">Equipos electronicos / celulares</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>N° poliza</label>
                    <input type="text" name="numero_poliza" required>
                </div>

                <div class="form-group">
                    <label>Fecha inicio</label>
                    <input type="date" name="fecha_inicio">
                </div>

                <div class="form-group">
                    <label>Fecha de vencimiento</label>
                    <input type="date" name="fecha_vencimiento" required>
                </div>

                <div class="form-group">
                    <label>Recordatorio renovacion</label>
                    <input type="date" name="aviso_renovacion">
                </div>

                <!-- NUEVO: Vigencia -->
                <div class="form-group">
                    <label>Vigencia</label>
                    <select name="vigencia">
                        <option value="">Seleccionar...</option>
                        <option value="ANUAL">Anual</option>
                        <option value="SEMESTRAL">Semestral</option>
                        <option value="TRIMESTRAL">Trimestral</option>
                        <option value="MENSUAL">Mensual</option>
                    </select>
                </div>

                <!-- NUEVO: Refacturacion -->
                <div class="form-group">
                    <label>Fecha de refacturacion (si corresponde)</label>
                    <input type="date" name="fecha_refacturacion">
                </div>

                <div class="form-group">
                    <label>Prima</label>
                    <input type="number" step="0.01" name="prima" required>
                </div>
                <div class="form-group">
                    <label>% Comision</label>
                    <input type="number" step="0.01" name="porcentaje" required>
                </div>
                <div class="form-group">
                    <label>PDF de poliza (opcional)</label>
                    <input type="file" name="archivo_pdf" accept="application/pdf">
                </div>
                <div class="form-group">
                    <label>Fotos de previas (opcional)</label>
                    <input type="file" name="fotos_previas" accept="image/*" multiple>
             </div>

            </div> <!-- cierre form-grid -->
            <br>
            <button class="btn btn-primary">Guardar poliza</button>
        </form>
    </div>

    <!-- LISTADO DE POLIZAS -->
    <div class="card table-card">
        <div style="display:flex; justify-content: space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <h3 style="margin-bottom:0;">Listado de polizas</h3>
            <form method="get" action="{{ url_for('ver_polizas') }}" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input type="text"
                       name="q"
                       placeholder="Buscar por cliente, DNI, compania..."
                       value="{{ q or '' }}">

                <select name="vigencia">
                    <option value="">Todas las vigencias</option>
                    <option value="ANUAL"      {% if filtro_vigencia == 'ANUAL' %}selected{% endif %}>Anual</option>
                    <option value="SEMESTRAL"  {% if filtro_vigencia == 'SEMESTRAL' %}selected{% endif %}>Semestral</option>
                    <option value="TRIMESTRAL" {% if filtro_vigencia == 'TRIMESTRAL' %}selected{% endif %}>Trimestral</option>
                    <option value="MENSUAL"    {% if filtro_vigencia == 'MENSUAL' %}selected{% endif %}>Mensual</option>
                </select>

                <select name="refacturacion">
                    <option value="">Todas</option>
                    <option value="CON" {% if filtro_refacturacion == 'CON' %}selected{% endif %}>Con refacturacion</option>
                    <option value="SIN" {% if filtro_refacturacion == 'SIN' %}selected{% endif %}>Sin refacturacion</option>
                </select>

                <button type="submit" class="btn btn-secondary">Buscar / Filtrar</button>
            </form>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>DNI</th>
                    <th>Localidad</th>
                    <th>Provincia</th>
                    <th>Productor</th>
                    <th>Compania</th>
                    <th>Tipo seguro</th>
                    <th>N° poliza</th>
                    <th>Vigencia</th>
                    <th>Refacturacion</th>
                    <th>Vence</th>
                    <th>Estado (vencimiento)</th>
                    <th>Situacion</th>
                    <th>Renovacion</th>
                    <th>Prima</th>
                    <th>% Com.</th>
                    <th>Comision</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
            {% for p in polizas %}
                <tr>
                    <td>{{ p.cliente }}</td>
                    <td>{{ p.dni or '-' }}</td>
                    <td>{{ p.localidad or '-' }}</td>
                    <td>{{ p.provincia or '-' }}</td>
                    <td>{{ p.productor_interno or '-' }}</td>
                    <td>{{ p.compania }}</td>
                    <td>{{ p.tipo_seguro or '-' }}</td>
                    <td>{{ p.numero_poliza }}</td>
                    <td>{{ p.vigencia or '-' }}</td>
                    <td>
                        {% if p.fecha_refacturacion %}
                            {{ p.fecha_refacturacion.strftime('%d/%m/%Y') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if p.fecha_vencimiento %}
                            {{ p.fecha_vencimiento.strftime('%d/%m/%Y') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if p.estado == 'VIGENTE' %}
                            <span class="badge badge-vigente">Vigente</span>
                        {% elif p.estado == 'POR VENCER' %}
                            <span class="badge badge-porvencer">Por vencer</span>
                        {% else %}
                            <span class="badge badge-vencida">Vencida</span>
                        {% endif %}
                    </td>
                    <td>
                        <form action="{{ url_for('cambiar_situacion_poliza', id=p.id) }}" method="post">
                            <select name="situacion" class="situacion-select" onchange="this.form.submit()">
                                <option value="ACTIVA"   {% if p.situacion == 'ACTIVA'   %}selected{% endif %}>Activa</option>
                                <option value="CANCELADA"{% if p.situacion == 'CANCELADA'%}selected{% endif %}>Cancelada</option>
                                <option value="BAJA"     {% if p.situacion == 'BAJA'     %}selected{% endif %}>Dada de baja</option>
                                <option value="ANULADA"  {% if p.situacion == 'ANULADA'  %}selected{% endif %}>Anulada</option>
                            </select>
                        </form>
                    </td>
                    <td>
                        <form action="{{ url_for('cambiar_renovacion', id=p.id) }}" method="post">
                            <select name="estado_renovacion" class="situacion-select" onchange="this.form.submit()">
                                <option value="PENDIENTE"   {% if p.estado_renovacion == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                                <option value="CONTACTADO" {% if p.estado_renovacion == 'CONTACTADO' %}selected{% endif %}>Contactado</option>
                                <option value="RENOVADA"   {% if p.estado_renovacion == 'RENOVADA' %}selected{% endif %}>Renovada</option>
                            </select>
                        </form>
                    </td>
                    <td>$ {{ '%.2f'|format(p.prima) }}</td>
                    <td>{{ p.porcentaje }} %</td>
                    <td>$ {{ '%.2f'|format(p.comision) }}</td>
                    <td>
                        <a href="{{ url_for('detalle_polizas_cliente', id=p.id) }}" class="pdf-link">Ver todo</a>
                        {% if p.wa_link %}
                            <a href="{{ p.wa_link }}" target="_blank" class="wa-link">WhatsApp</a>
                        {% endif %}
                        {% if p.archivo_pdf %}
                            <a href="{{ url_for('poliza_pdf', id=p.id) }}" target="_blank" class="pdf-link">Ver PDF</a>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="18">Todavia no hay polizas cargadas.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

{% endblock %}

{% block extra_head %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    var selectTipo = document.getElementById("tipo_seguro");
    var tituloVehiculo = document.getElementById("titulo_datos_vehiculo");
    var gruposVehiculo = document.querySelectorAll(".datos-vehiculo");

    function mostrarDatosVehiculo(mostrar) {
        if (tituloVehiculo) {
            tituloVehiculo.style.display = mostrar ? "block" : "none";
        }

        gruposVehiculo.forEach(function(grupo) {
            grupo.style.display = mostrar ? "block" : "none";

            if (!mostrar) {
                grupo.querySelectorAll("input, select").forEach(function(el) {
                    if (el.tagName === "SELECT") {
                        el.selectedIndex = 0;
                    } else {
                        el.value = "";
                    }
                });
            }
        });
    }

    function actualizarDatosVehiculo() {
        if (!selectTipo) return;
        var val = (selectTipo.value || "").toUpperCase();

        if (val === "AUTO" || val === "MOTO" || val === "PICKUP") {
            mostrarDatosVehiculo(true);
        } else {
            mostrarDatosVehiculo(false);
        }
    }

    if (selectTipo) {
        selectTipo.addEventListener("change", actualizarDatosVehiculo);
        actualizarDatosVehiculo();
    }
});
</script>
{% endblock %}