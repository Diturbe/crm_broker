{% extends "base.html" %}

{% block title %}Usuarios · CRM Broker{% endblock %}

{% block base_extra_css %}
    .usuarios-layout {
        display:flex;
        gap:20px;
        flex-wrap:wrap;
    }

    .card {
        background:white;
        border-radius:10px;
        padding:18px;
        box-shadow:0 2px 6px rgba(0,0,0,0.07);
        margin-bottom:20px;
    }

    .card h3 {
        margin-top:0;
        margin-bottom:10px;
        font-size:16px;
        color:#05386B;
    }

    .form-grid {
        display:grid;
        grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
        gap:10px 18px;
    }

    label {
        font-size:12px;
        font-weight:500;
        margin-bottom:3px;
        display:block;
    }
    input, select {
        width:100%;
        padding:6px 8px;
        border-radius:4px;
        border:1px solid #ccc;
        font-size:13px;
        background:#fff;
    }

    .permisos-group {
        border:1px solid #ddd;
        border-radius:6px;
        padding:8px;
        background:#f8f9fa;
        font-size:12px;
    }

    .btn {
        padding:7px 14px;
        border-radius:4px;
        border:none;
        font-size:13px;
        cursor:pointer;
    }
    .btn-primary { background:#05386B; color:#fff; }
    .btn-secondary { background:#6c757d; color:#fff; }
    .btn-xs { padding:4px 8px; font-size:11px; }

    table {
        width:100%;
        border-collapse:collapse;
        font-size:12px;
    }
    thead {
        background:#05386B;
        color:white;
    }
    th, td {
        padding:8px;
        border-bottom:1px solid #eee;
        text-align:left;
    }
    tr:nth-child(even) { background:#f9f9f9; }

    .badge {
        display:inline-block;
        padding:3px 8px;
        border-radius:999px;
        font-size:11px;
        font-weight:bold;
    }
    .badge.activo { background:#d4edda; color:#155724; }
    .badge.bloqueado { background:#f8d7da; color:#721c24; }
    .badge.pendiente { background:#fff3cd; color:#856404; }
{% endblock %}

{% block content %}

<h1>Usuarios</h1>
<p class="subtitle">Alta de usuarios, roles, permisos y estado de acceso al CRM.</p>

<div class="usuarios-layout">

    <div class="card" style="flex:1; min-width:280px;">
        <h3>Nuevo usuario</h3>
        <form action="{{ url_for('crear_usuario') }}" method="post" enctype="multipart/form-data">
            <div class="form-grid">
                <div>
                    <label>Nombre</label>
                    <input type="text" name="nombre">
                </div>
                <div>
                    <label>Apellido</label>
                    <input type="text" name="apellido">
                </div>
                <div>
                    <label>DNI</label>
                    <input type="text" name="dni">
                </div>
                <div>
                    <label>Fecha de nacimiento</label>
                    <input type="date" name="fecha_nacimiento">
                </div>
                <div>
                    <label>CUIT</label>
                    <input type="text" name="cuit">
                </div>

                <div>
                    <label>¿Es productor?</label>
                    <select name="es_productor">
                        <option value="">No</option>
                        <option value="1">Sí</option>
                    </select>
                </div>
                <div>
                    <label>Matrícula productor</label>
                    <input type="text" name="matricula">
                </div>

                <div>
                    <label>Rol</label>
                    <select name="rol" required>
                        <option value="usuario">Usuario</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>

                <div class="permisos-group" style="grid-column:1 / -1;">
                    <strong>Permisos</strong><br>
                    <label><input type="checkbox" name="permisos" value="polizas"> Pólizas</label>
                    <label><input type="checkbox" name="permisos" value="finanzas"> Finanzas</label>
                    <label><input type="checkbox" name="permisos" value="usuarios"> Usuarios</label>
                    <label><input type="checkbox" name="permisos" value="siniestros"> Siniestros</label>
                    <label><input type="checkbox" name="permisos" value="reportes"> Reportes</label>
                </div>

                <div>
                    <label>Email (acceso)</label>
                    <input type="email" name="email" required>
                </div>

                <div>
                    <label>CUIT (PDF)</label>
                    <input type="file" name="archivo_cuit" accept="application/pdf">
                </div>
                <div>
                    <label>Matrícula (PDF)</label>
                    <input type="file" name="archivo_matricula" accept="application/pdf">
                </div>
                <div>
                    <label>DNI (PDF)</label>
                    <input type="file" name="archivo_dni" accept="application/pdf">
                </div>
            </div>

            <br>
            <button type="submit" class="btn btn-primary">Crear usuario y enviar mail</button>
        </form>
    </div>

    <div class="card" style="flex:2; min-width:380px;">
        <h3>Listado de usuarios</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre completo</th>
                    <th>DNI</th>
                    <th>CUIT</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
            {% for u in usuarios %}
                <tr>
                    <td>{{ u.id }}</td>
                    <td>{{ u.apellido }}, {{ u.nombre }}</td>
                    <td>{{ u.dni or '-' }}</td>
                    <td>{{ u.cuit or '-' }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.rol }}</td>
                    <td>
                        {% if u.token_registro %}
                            <span class="badge pendiente">Pendiente</span>
                        {% elif u.activo %}
                            <span class="badge activo">Activo</span>
                        {% else %}
                            <span class="badge bloqueado">Bloqueado</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if u.token_registro %}
                            <form action="{{ url_for('usuarios_reenviar_mail', id=u.id) }}" method="post" style="display:inline;">
                                <button class="btn btn-xs btn-secondary">Reenviar mail</button>
                            </form>
                        {% else %}
                            <form action="{{ url_for('usuarios_reset_password', id=u.id) }}" method="post" style="display:inline;">
                                <button class="btn btn-xs btn-secondary">Reset clave</button>
                            </form>
                        {% endif %}

                        {% if not u.token_registro %}
                            <form action="{{ url_for('usuarios_bloquear', id=u.id) }}" method="post" style="display:inline;">
                                {% if u.activo %}
                                    <button class="btn btn-xs btn-secondary">Bloquear</button>
                                {% else %}
                                    <button class="btn btn-xs btn-secondary">Desbloquear</button>
                                {% endif %}
                            </form>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

</div>

{% endblock %}