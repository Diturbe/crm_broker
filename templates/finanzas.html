{% extends "base.html" %}

{% block title %}Finanzas · CRM Broker{% endblock %}

{% block base_extra_css %}
    .finanzas-container {
        max-width: 1150px;
        margin: 0 auto;
    }

    .summary {
        display:flex;
        gap:15px;
        margin-bottom:20px;
        flex-wrap:wrap;
    }
    .summary-card {
        flex:1;
        min-width:180px;
        background:white;
        border-radius:10px;
        padding:14px 16px;
        box-shadow:0 2px 6px rgba(0,0,0,0.07);
    }
    .summary-title {
        font-size:13px;
        color:#6c757d;
    }
    .summary-value {
        font-size:20px;
        font-weight:bold;
        margin-top:6px;
    }
    .ingreso { border-left:4px solid #28a745; }
    .egreso { border-left:4px solid #dc3545; }
    .saldo  { border-left:4px solid #0c3c78; }

    .card {
        background:white;
        border-radius:10px;
        padding:18px;
        box-shadow:0 2px 6px rgba(0,0,0,0.07);
        margin-bottom:20px;
    }

    .filter-row {
        display:flex;
        gap:10px;
        align-items:center;
        flex-wrap:wrap;
    }

    label {
        font-size:12px;
        color:#495057;
    }
    input, select {
        padding:6px 8px;
        border-radius:6px;
        border:1px solid #ced4da;
        font-size:13px;
    }
    .btn {
        padding:7px 14px;
        border-radius:4px;
        border:none;
        font-size:13px;
        cursor:pointer;
    }
    .btn-primary { background:#05386B; color:#fff; }
    .btn-secondary { background:#6c757d; color:#fff; }

    table {
        width:100%;
        border-collapse:collapse;
        font-size:12px;
    }
    thead {
        background:#05386B;
        color:white;
    }
    th, td {
        padding:8px;
        border-bottom:1px solid #eee;
        text-align:left;
    }
    tr:nth-child(even) { background:#f9f9f9; }

    .filter-info {
        font-size:12px;
        color:#6c757d;
        margin-bottom:6px;
    }
{% endblock %}

{% block content %}

<h1>Finanzas</h1>
<p class="subtitle">Control de ingresos, egresos y saldo mensual del estudio.</p>

<div class="finanzas-container">

    <div class="summary">
        <div class="summary-card ingreso">
            <div class="summary-title">Ingresos del mes</div>
            <div class="summary-value">$ {{ '%.2f'|format(total_ingresos) }}</div>
        </div>
        <div class="summary-card egreso">
            <div class="summary-title">Egresos del mes</div>
            <div class="summary-value">$ {{ '%.2f'|format(total_egresos) }}</div>
        </div>
        <div class="summary-card saldo">
            <div class="summary-title">Saldo neto</div>
            <div class="summary-value">$ {{ '%.2f'|format(saldo) }}</div>
        </div>
    </div>

    <div class="card">
        <h3>Filtrar por mes</h3>
        <form method="get" class="filter-row">
            <div>
                <label>Año</label><br>
                <input type="number" name="anio" value="{{ anio }}">
            </div>
            <div>
                <label>Mes</label><br>
                <input type="number" name="mes" value="{{ mes }}" min="1" max="12">
            </div>
            <div style="margin-top:18px;">
                <button type="submit" class="btn btn-secondary">Aplicar</button>
            </div>
        </form>
    </div>

    <div class="card">
        <h3>Nuevo movimiento</h3>
        <form method="post" action="{{ url_for('finanzas_agregar') }}">
            <div class="filter-row">
                <div>
                    <label>Fecha</label><br>
                    <input type="date" name="fecha" required>
                </div>
                <div>
                    <label>Tipo</label><br>
                    <select name="tipo" required>
                        <option value="ingreso">Ingreso</option>
                        <option value="egreso">Egreso</option>
                    </select>
                </div>
                <div>
                    <label>Categoría</label><br>
                    <input type="text" name="categoria" required>
                </div>
                <div style="flex:1; min-width:200px;">
                    <label>Descripción</label><br>
                    <input type="text" name="descripcion">
                </div>
            </div>

            <div class="filter-row" style="margin-top:10px;">
                <div>
                    <label>Compañía</label><br>
                    <input type="text" name="compania">
                </div>
                <div>
                    <label>Cliente</label><br>
                    <input type="text" name="cliente">
                </div>
                <div>
                    <label>N° póliza</label><br>
                    <input type="text" name="numero_poliza">
                </div>
                <div>
                    <label>Monto</label><br>
                    <input type="number" step="0.01" name="monto" required>
                </div>
                <div style="margin-top:18px;">
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </div>
            </div>
        </form>
    </div>

    <div class="card">
        <h3>Movimientos del mes</h3>
        <p class="filter-info">Mostrando movimientos de {{ mes }}/{{ anio }}.</p>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Categoría</th>
                    <th>Descripción</th>
                    <th>Compañía</th>
                    <th>Cliente</th>
                    <th>N° póliza</th>
                    <th>Monto</th>
                </tr>
            </thead>
            <tbody>
            {% for m in movimientos %}
                <tr>
                    <td>{{ m.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>{{ m.tipo }}</td>
                    <td>{{ m.categoria }}</td>
                    <td>{{ m.descripcion or '' }}</td>
                    <td>{{ m.compania or '' }}</td>
                    <td>{{ m.cliente or '' }}</td>
                    <td>{{ m.numero_poliza or '' }}</td>
                    <td>$ {{ '%.2f'|format(m.monto) }}</td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="8">No hay movimientos registrados para este mes.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

</div>

{% endblock %}